{% extends "base.html" %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --primary-blue: #2563eb;
        --primary-blue-dark: #1d4ed8;
        --primary-blue-light: #3b82f6;
        --primary-blue-lighter: #93c5fd;
        --card-bg: #1e293b;
        --card-bg-light: #2d3748;
        --text-soft: #f8fafc;
        --text-muted: #94a3b8;
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
        --border-dark: #334155;
        --border-light: #475569;
        --priority-high: #ef4444;
        --priority-medium: #f97316;
        --priority-low: #10b981;
        --accent-purple: #8b5cf6;
    }

    body {
        background-color: #0f172a;
        color: var(--text-soft);
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        border-color: rgba(59, 130, 246, 0.4);
    }

    .notification-bell {
        position: relative;
        transition: transform 0.2s ease;
    }

    .notification-bell:hover {
        transform: scale(1.1);
    }

    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--error);
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 0.2rem 0.4rem;
        border-radius: 9999px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .progress-bar-container {
        height: 8px;
        background-color: var(--border-dark);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(90deg, var(--primary-blue), var(--accent-purple));
        height: 100%;
        transition: width 0.5s ease;
    }

    .task-checklist-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }

    .task-checklist-item:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }

    .file-preview {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 8px;
        border: 1px solid var(--border-light);
    }

    .btn {
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: none;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        background: linear-gradient(135deg, var(--primary-blue-dark), var(--primary-blue));
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn-error {
        background: linear-gradient(135deg, var(--error), #dc2626);
        padding: 0.6rem 1.2rem;
    }

    .btn-error:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success), #059669);
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669, #047857);
    }

    .input, .textarea, .select {
        background-color: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--border-dark);
        color: var(--text-soft);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        width: 100%;
    }

    .input:focus, .textarea:focus, .select:focus {
        outline: none;
        border-color: var(--primary-blue-light);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .priority-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--border-dark);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-blue-light);
    }

    @media (min-width: 1024px) {
        .team-members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }
    }

    .fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary-blue);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 50;
        transition: all 0.3s ease;
    }

    .fab:hover {
        transform: scale(1.1) translateY(-5px);
        background: var(--primary-blue-light);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    .markdown-content {
        max-width: 100%;
        overflow-wrap: break-word;
    }

    .markdown-content p {
        margin-bottom: 0.5rem;
    }

    .markdown-content a {
        color: var(--primary-blue-light);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .markdown-content a:hover {
        color: var(--primary-blue-lighter);
        text-decoration: underline;
    }

    .notification-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        background: var(--card-bg);
        border: 1px solid var(--border-dark);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 100;
        transform-origin: top right;
        transform: scale(0.95);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }

    .notification-dropdown.show {
        transform: scale(1);
        opacity: 1;
        visibility: visible;
    }

    .task-card {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .task-card:hover {
        border-left-color: var(--primary-blue);
        background: rgba(59, 130, 246, 0.05);
    }

    .skill-tag {
        display: inline-block;
        background: rgba(59, 130, 246, 0.2);
        color: var(--primary-blue-light);
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-[#0f172a] to-[#1e293b] py-8">
    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for category, message in messages %}
                        <div class="flex items-center p-4 rounded-lg animate-fade-in 
                            {% if category == 'success' %}bg-green-900/30 border border-green-800 text-green-200
                            {% elif category == 'error' %}bg-red-900/30 border border-red-800 text-red-200
                            {% else %}bg-blue-900/30 border border-blue-800 text-blue-200{% endif %}">
                            <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-3"></i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Header with Notification and Logout -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                {% if team %}{{ team.name }}{% else %}Team Management{% endif %}
            </h1>
            
            <div class="flex items-center gap-4">
                {% if team %}
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 rounded-full hover:bg-blue-900/30 transition-colors relative notification-bell">
                            <i class="fas fa-bell text-xl text-blue-400"></i>
                            {% if unread_count > 0 %}
                                <span class="notification-badge">{{ unread_count }}</span>
                            {% endif %}
                        </button>
                        
                        <div id="notification-dropdown" class="notification-dropdown">
                            <div class="p-4 border-b border-border-dark sticky top-0 bg-card-bg z-10">
                                <h3 class="font-semibold">Notifications</h3>
                            </div>
                            {% if notifications %}
                                {% for task in notifications %}
                                    <div class="p-4 border-b border-border-dark hover:bg-blue-900/10 transition-colors">
                                        <p class="text-sm {% if task.is_read %}text-muted{% else %}text-soft font-medium{% endif %}">
                                            <i class="fas {% if task.message.startswith('Task completed') %}fa-check-circle text-green-500{% else %}fa-info-circle text-blue-500{% endif %} mr-2"></i>
                                            {{ task.message }}
                                        </p>
                                        <div class="flex justify-between items-center mt-2">
                                            <small class="text-xs text-muted">{{ task.created_at }}</small>
                                            {% if not task.is_read %}
                                                <button onclick="markNotificationRead({{ task.id }})" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                                                    Mark as read
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="p-8 text-center text-muted">
                                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                                    <p>No notifications yet</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                <form action="{{ url_for('logout') }}" method="POST">
                    <button type="submit" class="btn btn-error flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </form>
            </div>
        </div>

        {% if team %}
            <!-- Team Info Section -->
            <div class="card p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold mb-1">{{ team.name }}</h2>
                        <div class="flex flex-wrap items-center gap-3 text-sm text-muted">
                            <span class="flex items-center">
                                <i class="fas fa-users mr-1"></i>
                                <span id="member-count">{{ members_with_tasks|length }}</span> member{% if members_with_tasks|length != 1 %}s{% endif %}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-key mr-1"></i>
                                Join code: {{ team.join_code }}
                            </span>
                            {% if team.invite_password %}
                                <span class="flex items-center">
                                    <i class="fas fa-lock mr-1"></i>
                                    Password protected
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        {% if current_user_is_manager %}
                            <form action="{{ url_for('delete_team') }}" method="POST">
                                <button type="submit" onclick="return confirm('Are you sure you want to delete this team?')" 
                                    class="btn-error flex items-center">
                                    <i class="fas fa-trash mr-2"></i> Delete Team
                                </button>
                            </form>
                        {% endif %}
                        {% if not current_user_is_manager %}
                            <form action="{{ url_for('leave_team') }}" method="POST">
                                <button type="submit" onclick="return confirm('Are you sure you want to leave this team?')" 
                                    class="btn-error flex items-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Leave Team
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Task Assignment Form (For Managers) -->
            {% if current_user_is_manager %}
                <div class="card p-6 mb-8 animate-fade-in" id="task-form">
                    <h2 class="text-xl font-semibold mb-6 flex items-center">
                        <i class="fas fa-tasks mr-3 text-blue-400"></i>
                        Assign New Task
                    </h2>
                    <form action="{{ url_for('assign_team_task') }}" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label for="title" class="block text-sm font-medium mb-1">Task Title</label>
                                <input type="text" name="title" id="title" class="input" placeholder="Enter task title" required>
                            </div>
                            
                            <div>
                                <label for="assign_to" class="block text-sm font-medium mb-1">Assign To</label>
                                <select name="assign_to" id="assign_to" class="select" required>
                                  <option value="{{ member.id }}">
    {{ member.username }}
    {% if member.skills %}
        - {{ member.skills if member.skills is string else member.skills | join(', ') | truncate(30) }}
    {% endif %}
</option>

                                </select>
                            </div>
                            
                            <div>
                                <label for="priority" class="block text-sm font-medium mb-1">Priority</label>
                                <select name="priority" id="priority" class="select">
                                    <option value="High">High</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="visibility" class="block text-sm font-medium mb-1">Visibility</label>
                                <select name="visibility" id="visibility" class="select">
                                    <option value="only_me">Only Me</option>
                                    <option value="team" selected>Team</option>
                                    <option value="manager_only">Manager Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="description" class="block text-sm font-medium mb-1">Description</label>
                                <textarea name="description" id="description" class="textarea h-32" placeholder="Task description"></textarea>
                            </div>
                            
                            <div>
                                <label for="deadline" class="block text-sm font-medium mb-1">Deadline</label>
                                <input type="date" name="deadline" id="deadline" class="input" required>
                            </div>
                            
                            <div>
                                <label for="file" class="block text-sm font-medium mb-1">Attach File</label>
                                <input type="file" name="file" id="file" class="input p-1 text-sm" accept=".pdf,.png,.jpg,.jpeg,.docx,.zip">
                            </div>
                            
                            <button type="submit" class="btn w-full md:col-span-2 mt-2 flex items-center justify-center">
                                <i class="fas fa-paper-plane mr-2"></i> Assign Task
                            </button>
                        </div>
                    </form>
                </div>
            {% endif %}

            <!-- Skills Update Form for Members -->
            {% if not current_user_is_manager %}
                <div class="card p-6 mb-8 animate-fade-in">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-code-branch mr-3 text-blue-400"></i>
                        Your Skills
                    </h2>
                    <div class="mb-4">
                        {% if current_user_skills %}
                            <div class="flex flex-wrap gap-2 mb-4">
                                {% for skill in current_user_skills %}
                                    <span class="skill-tag">
                                        {{ skill }}
                                        <form action="{{ url_for('remove_skill', skill=skill) }}" method="POST" class="inline ml-2">
                                            <button type="submit" class="text-xs text-red-400 hover:text-red-300">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No skills added yet</p>
                        {% endif %}
                    </div>
                    <form action="{{ url_for('update_skills') }}" method="POST" class="flex gap-2">
                        <input type="text" name="skills" class="input flex-grow" placeholder="Add a new skill (e.g., Python, Design, etc.)" required>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus mr-2"></i> Add
                        </button>
                    </form>
                </div>
            {% endif %}

            <!-- Team Members & Tasks -->
            <h2 class="text-2xl font-semibold mb-6 flex items-center">
                <i class="fas fa-users mr-3 text-blue-400"></i>
                Team Members & Tasks
            </h2>
            
            <div class="team-members-grid space-y-6">
                {% for member in members_with_tasks %}
                    {% if not member.is_manager %}
                        <div class="card p-6 animate-fade-in" style="animation-delay: {{ loop.index * 0.05 }}s">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold">{{ member.username }}</h3>
                                    {% if member.skills %}
                                        <div class="mt-1 flex flex-wrap gap-1">
                                            {% for skill in member.skills %}
                                                <span class="skill-tag">{{ skill }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-muted">
                                    {{ member.tasks|length }} task{% if member.tasks|length != 1 %}s{% endif %}
                                </span>
                            </div>
                            
                            {% if member.tasks %}
                                <div class="space-y-4">
                                    {% for task in member.tasks %}
                                        {% if task.visibility == 'team' or (task.visibility == 'manager_only' and current_user_is_manager) or (task.visibility == 'only_me' and session['user_id'] == member.id) %}
                                            <div class="task-card p-4 rounded-lg">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-medium">{{ task.title }}</h4>
                                                    <span class="priority-tag 
                                                        {% if task.priority == 'High' %}bg-red-900/30 text-red-400
                                                        {% elif task.priority == 'Medium' %}bg-orange-900/30 text-orange-400
                                                        {% else %}bg-green-900/30 text-green-400{% endif %}">
                                                        {{ task.priority }}
                                                    </span>
                                                </div>
                                                
                                                {% if task.description %}
                                                    <p class="text-sm text-muted mb-3">{{ task.description|truncate(250) }}</p>
                                                {% endif %}
                                                
                                                <div class="flex flex-wrap items-center gap-3 text-xs text-muted mb-3">
                                                    <span class="flex items-center">
                                                        <i class="far fa-calendar-alt mr-1"></i>
                                                        Due: {{ task.deadline }}
                                                    </span>
                                                    <span class="status-badge 
                                                        {% if task.status == 'completed' %}bg-green-900/30 text-green-400
                                                        {% elif task.status == 'inprogress' %}bg-yellow-900/30 text-yellow-400
                                                        {% else %}bg-red-900/30 text-red-400{% endif %}">
                                                        {{ task.status|capitalize }}
                                                        {% if task.status == 'inprogress' %}({{ task.progress }}%){% endif %}
                                                    </span>
                                                </div>
                                                
                                                <!-- Progress Bar -->
                                                {% if task.status == 'inprogress' and session['user_id'] == member.id %}
                                                    <div class="mb-3">
                                                        <div class="progress-bar-container mb-1">
                                                            <div class="progress-bar" style="width: {{ task.progress }}%"></div>
                                                        </div>
                                                        <input type="range" min="0" max="100" value="{{ task.progress }}" 
                                                            onchange="updateProgress({{ task.id }}, this.value)" 
                                                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- Checklist -->
                                                {% if task.checklist %}
                                                    <div class="mb-3">
                                                        <h5 class="text-sm font-medium mb-2 flex items-center">
                                                            <i class="fas fa-check-square mr-2 text-blue-400"></i>
                                                            Checklist
                                                        </h5>
                                                        <div class="space-y-2">
                                                            {% for item, checked in task.checklist.items() %}
                                                                <label class="task-checklist-item cursor-pointer">
                                                                    <input type="checkbox" {{ 'checked' if checked }} 
                                                                        onchange="updateChecklist({{ task.id }}, '{{ item|escape }}', this.checked)"
                                                                        class="rounded border-border-dark bg-card-bg text-blue-500 focus:ring-blue-500">
                                                                    <span class="text-sm">{{ item }}</span>
                                                                </label>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- Files -->
                                                {% if task.filename %}
                                                    <div class="mb-3">
                                                        <h5 class="text-sm font-medium mb-2 flex items-center">
                                                            <i class="fas fa-paperclip mr-2 text-blue-400"></i>
                                                            Attachments
                                                        </h5>
                                                        <div class="flex items-center gap-2">
                                                            {% if task.filename.endswith(('.png', '.jpg', '.jpeg')) %}
                                                                <a href="{{ url_for('download_task_file', task_id=task.id) }}" 
                                                                   class="text-blue-400 hover:text-blue-300 transition-colors flex items-center">
                                                                    <i class="fas fa-image mr-1"></i> View Image
                                                                </a>
                                                            {% elif task.filename.endswith('.pdf') %}
                                                                <a href="{{ url_for('download_task_file', task_id=task.id) }}" 
                                                                   class="text-blue-400 hover:text-blue-300 transition-colors flex items-center">
                                                                    <i class="fas fa-file-pdf mr-1"></i> View PDF
                                                                </a>
                                                            {% else %}
                                                                <a href="{{ url_for('download_task_file', task_id=task.id) }}" 
                                                                   class="text-blue-400 hover:text-blue-300 transition-colors flex items-center">
                                                                    <i class="fas fa-file-download mr-1"></i> {{ task.filename|truncate(20) }}
                                                                </a>
                                                            {% endif %}
                                                            <span class="text-xs text-muted">v{{ task.version or 1 }}</span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- Actions -->
                                                <div class="flex flex-wrap gap-2 mb-3">
                                                    {% if session['user_id'] == member.id %}
                                                        {% if task.status == 'pending' %}
                                                            <form action="{{ url_for('approve_task', task_id=task.id) }}" method="POST" class="flex-1">
                                                                <button type="submit" class="btn-success w-full flex items-center justify-center">
                                                                    <i class="fas fa-check mr-2"></i> Accept Task
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                        {% if task.status == 'inprogress' %}
                                                            <button onclick="completeTask({{ task.id }})" 
                                                                class="btn-success flex items-center justify-center">
                                                                <i class="fas fa-flag-checkered mr-2"></i> Complete
                                                            </button>
                                                            
                                                            <form action="{{ url_for('upload_task_file', task_id=task.id) }}" method="POST" 
                                                                  enctype="multipart/form-data" class="flex-1 flex gap-2">
                                                                <input type="file" name="file" class="input p-1 text-sm flex-grow" 
                                                                       accept=".pdf,.png,.jpg,.jpeg,.docx,.zip">
                                                                <button type="submit" class="btn flex items-center">
                                                                    <i class="fas fa-upload mr-1"></i>
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    {% endif %}
                                                    
                                                    {% if current_user_is_manager %}
                                                        <form action="{{ url_for('edit_task', task_id=task.id) }}" method="GET" class="flex-1">
                                                            <button type="submit" class="btn w-full flex items-center justify-center">
                                                                <i class="fas fa-edit mr-2"></i> Edit
                                                            </button>
                                                        </form>
                                                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" class="flex-1">
                                                            <button type="submit" class="btn-error w-full flex items-center justify-center">
                                                                <i class="fas fa-trash mr-2"></i> Delete
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Comments -->
                                                <div>
                                                    <h5 class="text-sm font-medium mb-2 flex items-center">
                                                        <i class="fas fa-comments mr-2 text-blue-400"></i>
                                                        Comments
                                                    </h5>
                                                    
                                                    <div class="space-y-3 mb-3 max-h-40 overflow-y-auto p-1">
                                                        {% for comment in task.comments %}
                                                            <div class="text-sm">
                                                                <div class="markdown-content bg-slate-800/50 p-3 rounded-lg">
                                                                    {{ comment.content | markdown | replace("<p>", "") | replace("</p>", "") }}
                                                                </div>
                                                                <div class="flex justify-between items-center mt-1 px-1">
                                                                    <span class="text-xs text-muted">{{ comment.username }}</span>
                                                                    <span class="text-xs text-muted">{{ comment.created_at }}</span>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    
                                                    <form action="{{ url_for('add_task_comment', task_id=task.id) }}" method="POST" class="flex gap-2">
                                                        <textarea name="content" class="textarea flex-grow text-sm" placeholder="Add a comment..." rows="2"></textarea>
                                                        <button type="submit" class="btn self-end h-full">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4 text-muted">
                                    <i class="fas fa-tasks text-2xl mb-2"></i>
                                    <p>No tasks assigned</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <!-- No Team Section -->
            <div class="card p-8 text-center max-w-2xl mx-auto animate-fade-in">
                <div class="mb-6">
                    <i class="fas fa-users text-5xl text-blue-400 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">You're not in a team yet</h2>
                    <p class="text-muted">Create a new team or join an existing one to get started</p>
                </div>
                
                <div class="space-y-6">
                    <div class="card p-6 bg-slate-800/50">
                        <h3 class="text-lg font-semibold mb-4 flex items-center justify-center">
                            <i class="fas fa-plus-circle mr-2 text-blue-400"></i>
                            Create New Team
                        </h3>
                        <form action="{{ url_for('create_team') }}" method="POST" class="space-y-4">
                            <div>
                                <label for="team_name" class="block text-sm font-medium mb-1">Team Name</label>
                                <input type="text" name="team_name" id="team_name" class="input w-full" placeholder="Enter team name" required>
                            </div>
                            <div>
                                <label for="invite_password" class="block text-sm font-medium mb-1">Invite Password (Optional)</label>
                                <input type="password" name="invite_password" id="invite_password" class="input w-full" placeholder="Set a password for joining">
                            </div>
                            <button type="submit" class="btn w-full flex items-center justify-center">
                                <i class="fas fa-rocket mr-2"></i> Create Team
                            </button>
                        </form>
                    </div>
                    
                    <div class="relative flex items-center">
                        <div class="flex-grow border-t border-slate-600"></div>
                        <span class="flex-shrink mx-4 text-muted">OR</span>
                        <div class="flex-grow border-t border-slate-600"></div>
                    </div>
                    
                    <div class="card p-6 bg-slate-800/50">
                        <h3 class="text-lg font-semibold mb-4 flex items-center justify-center">
                            <i class="fas fa-sign-in-alt mr-2 text-blue-400"></i>
                            Join Existing Team
                        </h3>
                        <form action="{{ url_for('join_team') }}" method="POST" class="space-y-4">
                            <div>
                                <label for="join_code" class="block text-sm font-medium mb-1">Join Code</label>
                                <input type="text" name="join_code" id="join_code" class="input w-full" placeholder="Enter team join code" required>
                            </div>
                            <div>
                                <label for="invite_password" class="block text-sm font-medium mb-1">Invite Password (If Required)</label>
                                <input type="password" name="invite_password" id="invite_password" class="input w-full" placeholder="Enter password">
                            </div>
                            <button type="submit" class="btn-success w-full flex items-center justify-center">
                                <i class="fas fa-user-plus mr-2"></i> Join Team
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Mobile Floating Action Button -->
    {% if team and current_user_is_manager %}
        <div class="fab md:hidden" onclick="document.getElementById('task-form').scrollIntoView({ behavior: 'smooth' })">
            <i class="fas fa-plus text-xl"></i>
        </div>
    {% endif %}

    <script>
        // Auto-refresh page every 2 seconds (from previous request)
        

        // Check for new team members every 5 seconds
        let lastMemberCount = {{ members_with_tasks|length }};
        setInterval(() => {
            fetch('/team_members_count', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.member_count !== lastMemberCount) {
                    window.location.reload();
                }
            })
            .catch(error => console.error('Error checking member count:', error));
        }, 5000);

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show')) {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && !e.target.closest('.notification-bell')) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }
        }

        // Mark notification as read
        function markNotificationRead(id) {
            fetch(`/mark_notification_read/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    window.location.reload();
                }
            });
        }

        // Update task progress
        function updateProgress(taskId, value) {
            fetch(`/update_progress/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ progress: value })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    window.location.reload();
                }
            });
        }

        // Update checklist item
        function updateChecklist(taskId, item, checked) {
            fetch(`/update_checklist/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item, checked })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    const checkbox = document.querySelector(`input[onchange*="updateChecklist(${taskId}, '${item}'"]`);
                    if (checkbox) {
                        checkbox.checked = !checked;
                    }
                }
            });
        }

        // Complete task
        function completeTask(taskId) {
            if (confirm('Are you sure you want to mark this task as completed?')) {
                fetch(`/status/${taskId}/completed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        window.location.reload();
                    }
                });
            }
        }

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</div>
{% endblock %}